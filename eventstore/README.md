# EventStore
EventStore 主要目的是用来存储聚合根产生的事件，及聚合根事件回放功能。</br> 
下面提供一些要实现EventStore的思路

## CQRS+ES架构怎么通过聚合根事件同步读模型
- 一般的做法是聚合根产生事件，事件通过事件通道EventBus发布，然后读模型监听事件，然后更新。（跟消息发送的推模式一样）
- 聚合根产生事件，事件顺序存储在EventStore中，然后读模型定时去读取事件（一般通过最后接收到的version去读取最新事件），然后更新。
 （跟消息发送的拉模式一样）
- 结合前面两种方式，消息推拉结合，这应该是比较好的方式。

> 注：文件操作怎么保存聚合根事件这块我先不考虑，这方法等我深入研究再来分析这方面的问题。可以先用个数据库来实现EventStore

### 这里我想说的是第2种方式（这是从DistributedLog分布式日志库中得到的灵感），先说下这种方式的优点：
- 通过这种方式，存储在EventStore中的事件流就变得很活跃，可以用于聚合根、读模型、需要同步这些事件的模型（如聚合根事件迁移）
- 以比较简单的方法解决了数据最终一致性问题。传统方式是通过消息服务把事件发送给读模型，但这种方式就要解决消息发送的乱序、丢失等问题
 （一般通过消息服务来保证，相当于命运掌握在别人手中 哈）；
  假如读模型直接去读EventStore的事件来同步呢？这些事件就在EventStore，假如你发现不对了你就去读取然后更新就可以
  
### 缺点
- 由于要读端去验证数据正确性，增加读端的复杂性，但这种控制也比较简单（可以通过版本号之类的属性控制）；
- 由于读端是定时去拉数据，可能没有推的方式那么实时（第一种方式）
- EventStore的实现难度就更加大了

## 小结
这里只是提供一种思路给大家参考，EventStore这块我没什么经验，假如自己实现EventStore，有下面这些问题要解决：
- 聚合根事件怎么顺序写入？
- 怎么快速读出聚合根某个范围或所有事件？
- 聚合根事件是放在一个文件还是多个文件？文件怎么布局？
- 文件损坏怎么处理？

## 参考
http://h2ex.com/552?utm_source=tuicool&utm_medium=referral

